name: Release Extension

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# æ˜¾å¼è®¾ç½®æƒé™ï¼Œéµå¾ªæœ€å°æƒé™åŸåˆ™
permissions:
  contents: write  # éœ€è¦å†™å…¥æƒé™ä»¥åˆ›å»º Release
  actions: read    # åªéœ€è¯»å–æƒé™
  checks: read     # åªéœ€è¯»å–æƒé™

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.19.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.21.0'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Chrome Extension
        run: pnpm build:chrome

      - name: Build Firefox Extension
        run: pnpm build:firefox

      - name: Build Edge Extension
        run: pnpm build:edge

      - name: Create distribution packages
        run: |
          # è¿›å…¥æ„å»ºç›®å½•
          cd build

          # æ‰“åŒ… Chrome ç‰ˆæœ¬
          cd chrome-mv3-prod
          zip -r ../../88code-cost-chrome-${{ github.ref_name }}.zip .
          cd ..

          # æ‰“åŒ… Firefox ç‰ˆæœ¬
          cd firefox-mv2-prod
          zip -r ../../88code-cost-firefox-${{ github.ref_name }}.zip .
          cd ..

          # æ‰“åŒ… Edge ç‰ˆæœ¬
          cd edge-mv3-prod
          zip -r ../../88code-cost-edge-${{ github.ref_name }}.zip .
          cd ..

      - name: Extract version from package.json
        id: package_version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ github.ref_name }}"
          # ç§»é™¤ v å‰ç¼€ï¼Œä¾‹å¦‚ v1.0.0 -> 1.0.0
          VERSION_NUMBER="${VERSION#v}"

          # ä½¿ç”¨ awk æå–å¯¹åº”ç‰ˆæœ¬çš„ CHANGELOG å†…å®¹
          CHANGELOG_CONTENT=$(awk -v version="$VERSION_NUMBER" '
            /^## \[/ {
              if (found) exit
              if ($0 ~ "\\[" version "\\]") {
                found=1
                next
              }
            }
            found && /^## \[/ { exit }
            found { print }
          ' CHANGELOG.md)

          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„ CHANGELOGï¼Œä½¿ç”¨é»˜è®¤æè¿°
          if [ -z "$CHANGELOG_CONTENT" ]; then
            CHANGELOG_CONTENT="## ğŸ“¦ 88Code Cost ${VERSION}

          æ„Ÿè°¢ä½¿ç”¨ 88Code Costï¼æœ¬æ¬¡å‘å¸ƒåŒ…å«ä»¥ä¸‹æµè§ˆå™¨ç‰ˆæœ¬ï¼š

          - ğŸŸ¦ Chrome / Edge (Manifest V3)
          - ğŸŸ§ Firefox (Manifest V2)

          è¯¦ç»†æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md)ã€‚"
          fi

          # ä½¿ç”¨ heredoc ä¿å­˜å¤šè¡Œå†…å®¹
          {
            echo 'CONTENT<<EOF'
            echo "$CHANGELOG_CONTENT"
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ${{ steps.changelog.outputs.CONTENT }}

            ---

            ## ğŸ“¥ ä¸‹è½½è¯´æ˜

            è¯·æ ¹æ®æ‚¨çš„æµè§ˆå™¨é€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬ä¸‹è½½ï¼š

            - **Chrome / Edge**ï¼šä¸‹è½½ `88code-cost-chrome-${{ github.ref_name }}.zip`
            - **Firefox**ï¼šä¸‹è½½ `88code-cost-firefox-${{ github.ref_name }}.zip`

            ## ğŸ“– å®‰è£…æŒ‡å—

            è¯¦ç»†å®‰è£…æ­¥éª¤è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md#å®‰è£…æ–¹å¼)ã€‚

            ## ğŸ”— ç›¸å…³é“¾æ¥

            - [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md)
            - [ä½¿ç”¨æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md)
            - [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
          files: |
            88code-cost-chrome-${{ github.ref_name }}.zip
            88code-cost-firefox-${{ github.ref_name }}.zip
            88code-cost-edge-${{ github.ref_name }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Chrome artifact
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension
          path: 88code-cost-chrome-${{ github.ref_name }}.zip
          retention-days: 90

      - name: Upload Firefox artifact
        uses: actions/upload-artifact@v4
        with:
          name: firefox-extension
          path: 88code-cost-firefox-${{ github.ref_name }}.zip
          retention-days: 90

      - name: Upload Edge artifact
        uses: actions/upload-artifact@v4
        with:
          name: edge-extension
          path: 88code-cost-edge-${{ github.ref_name }}.zip
          retention-days: 90
